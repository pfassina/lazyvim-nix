name: Verify Parser Hashes

on:
  schedule:
    # Run daily at 6 AM UTC (after update-plugins at 2 AM)
    - cron: '0 6 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  verify-hashes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: cachix/cachix-action@v12
        with:
          name: nix-community
          skipPush: true

      - name: Verify and fix parser hashes
        id: verify
        run: |
          set -euo pipefail

          REVISIONS_FILE="data/parser-revisions.json"

          # Nix expression returning individual fetchgit derivations per parser.
          # Uses fetchSubmodules = false to match nix/lib/treesitter.nix.
          cat > verify-parsers.nix << 'EOF'
          let
            pkgs = import <nixpkgs> {};
            revisions = builtins.fromJSON (builtins.readFile ./data/parser-revisions.json);
            fetchParser = name: parser: pkgs.fetchgit {
              url = parser.url;
              rev = parser.revision;
              sha256 = parser.sha256;
              fetchSubmodules = false;
            };
          in pkgs.lib.mapAttrs fetchParser revisions.parsers
          EOF

          PARSERS=$(jq -r '.parsers | keys[]' "$REVISIONS_FILE")
          TOTAL=$(echo "$PARSERS" | wc -w)
          FIXED_PARSERS=""

          echo "Verifying $TOTAL parsers..."

          # Phase 1: populate store paths from cache (fast)
          for parser in $PARSERS; do
            nix-build --no-out-link verify-parsers.nix -A "$parser" 2>/dev/null || true
          done

          # Phase 2: re-fetch each parser with --check to verify hashes
          # against current upstream content (detects archive regeneration)
          for parser in $PARSERS; do
            if ! nix-build --check --no-out-link verify-parsers.nix -A "$parser" 2>/dev/null; then
              echo "MISMATCH: $parser"

              url=$(jq -r ".parsers[\"$parser\"].url" "$REVISIONS_FILE")
              rev=$(jq -r ".parsers[\"$parser\"].revision" "$REVISIONS_FILE")
              old_hash=$(jq -r ".parsers[\"$parser\"].sha256" "$REVISIONS_FILE")

              NEW_HASH=$(nix-prefetch-git --url "$url" --rev "$rev" 2>/dev/null | jq -r '.sha256')

              if [ -n "$NEW_HASH" ] && [ "$NEW_HASH" != "null" ]; then
                echo "  Fixed $parser: $old_hash -> $NEW_HASH"
                jq ".parsers[\"$parser\"].sha256 = \"$NEW_HASH\"" "$REVISIONS_FILE" > tmp.json
                mv tmp.json "$REVISIONS_FILE"
                FIXED_PARSERS="$FIXED_PARSERS $parser"
              else
                echo "  ERROR: Could not determine correct hash for $parser"
              fi
            fi
          done

          if [ -n "$FIXED_PARSERS" ]; then
            echo "Fixed parsers:$FIXED_PARSERS"
            echo "needs_fix=true" >> $GITHUB_OUTPUT
            echo "fixed_parsers=$FIXED_PARSERS" >> $GITHUB_OUTPUT
          else
            echo "All parser hashes verified successfully"
            echo "needs_fix=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.verify.outputs.needs_fix == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "fix: update broken tree-sitter parser hashes"
          title: "Fix broken tree-sitter parser hashes"
          body: |
            This PR fixes tree-sitter parser hashes that no longer match their upstream content.

            This can happen when GitHub regenerates archive tarballs or when repositories with
            submodules have their submodule content change.

            ## Fixed Parsers
            ${{ steps.verify.outputs.fixed_parsers || 'See commit diff for details' }}

            ## Verification
            - [ ] Flake check passes
            - [ ] Parser builds succeed

            ---
            *This pull request was automatically generated by the hash verification workflow.*
          branch: fix-parser-hashes
          delete-branch: true
          add-paths: |
            data/parser-revisions.json
